<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8">
<title>Träff</title>
<link rel="stylesheet" href="styles.css">
<link rel="icon" type="image/png" sizes="128x128" href="logowebb.png">

<style>
body { font-family: 'Poppins', sans-serif; background-color: #fafafa; margin: 0; color: #333; }
.navbar { display: flex; align-items: center; padding: 10px 20px; background: #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
.navbar .logo img { height: 40px; }
.navbar .icon img { height: 32px; cursor: pointer; margin-left: auto; }
.dropdown { display: none; flex-direction: column; position: absolute; top: 60px; right: 20px; background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
.dropdown a { padding: 10px 20px; text-decoration: none; color: #333; }
.group-section { max-width: 900px; margin: 50px auto; padding: 20px; background: #fff; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
.group-header h2 { margin: 0 0 10px 0; }
.group-header p { margin: 2px 0 15px 0; color: #666; }
.participants, .messages { margin-bottom: 20px; }
.participants { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
.participants strong { margin-right: 10px; }
.avatar { width: 34px; height: 34px; border-radius: 50%; background: black; color: white; display: flex; align-items: center; justify-content: center; font-size: 13px; }
.message { margin-bottom: 10px; }
.message strong { margin-right: 5px; }
.chat-box { display: flex; gap: 8px; }
.chat-box input { flex: 1; padding: 10px; border: 2px solid #333; }
.chat-box button { padding: 10px 15px; border: 2px solid #333; background: transparent; cursor: pointer; }
.leave-btn { padding: 10px 15px; border: 2px solid red; background: transparent; color: red; cursor: pointer; margin-top: 10px; }
</style>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

</head>
<body>

<div class="navbar">
  <div class="icon" onclick="toggleMenu()">☰</div>
  <div class="logo"><a href="index.html"><img src="logo.png"></a></div>
  <div class="icon"><a href="profile.html"><img src="profile.png"></a></div>
</div>

<div class="dropdown" id="menu">
  <a href="index.html">Hem</a>
  <a href="activities.html">Hitta & Boka</a>
  <a href="index.html#about">Om oss</a>
  <a href="profile.html">Min Profil</a>
</div>

<section class="group-section">
  <div class="group-header">
    <h2 id="groupName">Träff</h2>
    <p id="groupInfo">Stad • Datum</p>
  </div>

  <div class="participants">
    <strong>Deltagare:</strong>
    <div id="participantsContainer"></div>
  </div>

  <div class="messages">
    <strong>Chatt:</strong>
    <div id="messagesContainer" style="max-height:300px; overflow-y:auto;"></div>
  </div>

  <div class="chat-box">
    <input type="text" id="chatInput" placeholder="Skriv meddelande...">
    <button id="sendBtn">Skicka</button>
  </div>

  <button class="leave-btn" id="leaveBtn">Lämna träff</button>
</section>

<script>
function toggleMenu() {
  const menu = document.getElementById("menu");
  menu.style.display = menu.style.display === "block" ? "none" : "block";
}

// URL-param
const urlParams = new URLSearchParams(window.location.search);
const groupId = urlParams.get("id");

// Firebase init
const firebaseConfig = {
  apiKey: "AIzaSyCqYwtoHMQ19zLYQN47vXskCmrrbkDFLgs",
  authDomain: "atatillsammans-7b612.firebaseapp.com",
  projectId: "atatillsammans-7b612",
  storageBucket: "atatillsammans-7b612.firebasestorage.app",
  messagingSenderId: "462939649454",
  appId: "1:462939649454:web:474a3e72987ed25e7a443f",
  measurementId: "G-QMC3ZL711E"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const auth = firebase.auth();

// Anonym login
auth.signInAnonymously().then(()=>{
  const user = auth.currentUser;
  window.currentUser = { uid: user.uid, name: "Gäst" + user.uid.slice(-4) };
  initGroup();
});

function initGroup() {
  const groupRef = db.ref("groups/" + groupId);
  const participantsContainer = document.getElementById("participantsContainer");
  const messagesContainer = document.getElementById("messagesContainer");
  const groupNameEl = document.getElementById("groupName");
  const groupInfoEl = document.getElementById("groupInfo");
  const chatInput = document.getElementById("chatInput");
  const sendBtn = document.getElementById("sendBtn");
  const leaveBtn = document.getElementById("leaveBtn");

  // Lägg till användaren som medlem om inte redan
  groupRef.child("members/" + window.currentUser.uid).set(window.currentUser.name);

  // Lyssna på gruppdata
  groupRef.on("value", snapshot=>{
    const group = snapshot.val();
    if(!group){
      alert("Träffen finns inte längre!");
      window.location.href = "activities.html";
      return;
    }

    groupNameEl.textContent = group.name;
    groupInfoEl.textContent = `${group.city} • ${new Date(group.time).toLocaleString("sv-SE")}`;

    // Deltagare
    participantsContainer.innerHTML = "";
    const members = group.members || {};
    Object.values(members).forEach(name=>{
      const avatar = document.createElement("div");
      avatar.className = "avatar";
      avatar.textContent = name[0];
      avatar.title = name;
      participantsContainer.appendChild(avatar);
    });

    // Chatt
    messagesContainer.innerHTML = "";
    const messages = group.messages || [];
    messages.forEach(msg=>{
      const div = document.createElement("div");
      div.className = "message";
      div.innerHTML = `<strong>${msg.user}:</strong> ${msg.text}`;
      messagesContainer.appendChild(div);
    });
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
  });

  // Skicka meddelande
  sendBtn.addEventListener("click", ()=>{
    const text = chatInput.value.trim();
    if(!text) return;
    const msgRef = groupRef.child("messages");
    msgRef.once("value").then(snapshot=>{
      const msgs = snapshot.val() || [];
      msgs.push({ user: window.currentUser.name, text });
      msgRef.set(msgs);
      chatInput.value = "";
    });
  });

  // Enter för att skicka
  chatInput.addEventListener("keydown", e=>{
    if(e.key === "Enter") sendBtn.click();
  });

  // Lämna träff
  leaveBtn.addEventListener("click", ()=>{
    if(!confirm("Är du säker på att du vill lämna träffen?")) return;
    groupRef.child("members/" + window.currentUser.uid).remove()
      .then(()=> window.location.href="activities.html");
  });
}
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8">
<title>Träffdetaljer</title>
<link rel="stylesheet" href="styles.css">
<link rel="icon" type="image/png" sizes="128x128" href="logowebb.png">
<style>
/* -------- GLOBAL STYLES -------- */
body { font-family: 'Poppins', sans-serif; background-color: #fafafa; margin: 0; color: #333; }

/* -------- NAVBAR (SVART DESIGN) -------- */
.navbar { 
  display: flex; 
  justify-content: space-between; 
  align-items: center; 
  padding: 15px 20px; 
  background: #000; 
  color: #fff;      
  position: relative;
  z-index: 1000;
}

.navbar a {
  color: #fff; 
  text-decoration: none;
  display: flex;
  align-items: center;
}

.navbar .logo img { 
  height: 40px; 
  display: block;
}

.icon {
  font-size: 24px;
  cursor: pointer;
  width: 30px; 
  text-align: center;
}
.icon:last-child {
  text-align: right;
}

/* -------- DROPDOWN MENU -------- */
.dropdown { 
  display: none; 
  flex-direction: column; 
  position: absolute; 
  top: 70px; 
  left: 0;   
  background: #111; 
  box-shadow: 0 4px 8px rgba(0,0,0,0.3); 
  width: 200px;
  z-index: 999;
}

.dropdown a { 
  padding: 15px 20px; 
  text-decoration: none; 
  color: #fff; 
  border-bottom: 1px solid #333;
}

.dropdown a:hover {
  background: #333;
}

/* -------- GRUPP SEKTION -------- */
.group-section { 
    max-width: 900px; 
    margin: 50px auto; 
    padding: 30px; 
    background: #fff; 
    box-shadow: 0 4px 12px rgba(0,0,0,0.05); 
    border-radius: 8px;
}

.group-section h2 { margin-top: 0; font-size: 28px; }

.info-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 30px;
    border-bottom: 1px solid #eee;
    padding-bottom: 20px;
}

.info-item label { font-size: 12px; color: #777; font-weight: bold; text-transform: uppercase; display: block; margin-bottom: 4px; }
.info-item p { margin: 0; font-size: 16px; font-weight: 500; }

.participants-section h3 { font-size: 18px; margin-bottom: 10px; }
.participants { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }
.avatar { 
    width: 40px; 
    height: 40px; 
    border-radius: 50%; 
    background: #333; 
    color: white; 
    display:flex; 
    align-items:center; 
    justify-content:center; 
    font-size: 16px; 
    font-weight: bold;
    cursor: help; /* Visar att man kan hålla musen över för namn */
}

.status-full { color: red; font-weight: bold; }
.status-open { color: green; font-weight: bold; }

.leave-btn { 
    margin-top: 30px; 
    padding: 12px 25px; 
    border: 2px solid #d9534f; 
    background: transparent; 
    color: #d9534f; 
    cursor: pointer; 
    font-weight: bold; 
    border-radius: 4px;
    transition: 0.2s;
}
.leave-btn:hover { background: #d9534f; color: white; }

</style>
</head>
<body>

<div class="navbar">
  <div class="icon" id="menuToggle">☰</div>
  <div class="logo"><a href="index.html"><img src="logo.png" alt="Logo"></a></div>
  <div class="icon"><a href="profile.html"><img src="profile.png" alt="Profil"></a></div>
</div>

<div class="dropdown" id="menu">
  <a href="index.html">Hem</a>
  <a href="activities.html">Hitta & Boka</a>
  <a href="index.html#about">Om oss</a>
  <a href="profile.html">Min Profil</a>
</div>

<section class="group-section">
  <h2 id="groupName">Laddar...</h2>

  <div class="info-grid">
      <div class="info-item">
          <label>Tid</label>
          <p id="groupTime">-</p>
      </div>
      <div class="info-item">
          <label>Plats</label>
          <p id="groupLocation">-</p>
      </div>
      <div class="info-item">
          <label>Adress</label>
          <p id="groupAddress">-</p>
      </div>
      <div class="info-item">
          <label>Platser</label>
          <p id="groupSeats">-</p>
      </div>
  </div>

  <div class="participants-section">
      <h3>Deltagare</h3>
      <div class="participants" id="participantsContainer"></div>
      <p id="noParticipantsMsg" style="display:none; color:#777; font-style:italic;">Inga deltagare än.</p>
  </div>

  <button class="leave-btn" id="leaveBtn">Gå ur träff</button>
</section>

<footer style="background:#222; color:#fff; text-align:center; padding:20px; margin-top: 50px;">
  © 2026 Äta Tillsammans
</footer>

<script>
const API = "http://localhost:3123"

// ---------------- MENU ----------------
const menuToggle = document.getElementById("menuToggle")
const menu = document.getElementById("menu")

menuToggle.onclick = () => {
  menu.style.display = menu.style.display === "flex" ? "none" : "flex"
}

// ---------------- LOGIN (MOCK) ----------------
async function getProfile() {
  return { id: 1, firstName: "Test" }
}

// ---------------- STATE ----------------
let currentUser = null
let activity = null
let participants = []
let currentLocation = null

const params = new URLSearchParams(window.location.search)
const activityId = params.get("id")

// ---------------- API ----------------
async function getActivity(id) {
  const res = await fetch(`${API}/activity/${id}`)
  if (!res.ok) throw new Error("Träff hittades inte")
  return res.json()
}

// Ny funktion för att hämta alla locations och hitta rätt
async function getLocation(locId) {
    const res = await fetch(`${API}/location`)
    if (!res.ok) return null
    const locations = await res.json()
    return locations.find(l => l.id === locId)
}

async function getParticipants(id) {
  const res = await fetch(`${API}/userActivity/activity/${id}`)
  if (!res.ok) return []

  const relations = await res.json()
  const users = await fetch(`${API}/users`).then(r => r.json())
  return relations.map(r => users.find(u => u.id === r.userId))
}

async function joinActivity() {
  await fetch(`${API}/userActivity`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ userId: currentUser.id, activityId })
  })
}

async function leaveActivity() {
  await fetch(`${API}/userActivity`, {
    method: "DELETE",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ userId: currentUser.id, activityId })
  })
  window.location.href = "activities.html"
}

// ---------------- RENDER ----------------
function render() {
  // 1. Grundinfo
  document.getElementById("groupName").textContent = activity.name
  document.getElementById("groupTime").textContent = new Date(activity.time).toLocaleString("sv-SE", { dateStyle: 'long', timeStyle: 'short' })
  
  // 2. Platsinfo
  if (currentLocation) {
      document.getElementById("groupLocation").textContent = currentLocation.city
      document.getElementById("groupAddress").textContent = currentLocation.address
  } else {
      document.getElementById("groupLocation").textContent = "Okänd plats"
      document.getElementById("groupAddress").textContent = "-"
  }

  // 3. Platser (Matematik)
  const totalSeats = activity.seats
  const bookedSeats = participants.length
  const seatsEl = document.getElementById("groupSeats")
  
  if (bookedSeats >= totalSeats) {
      seatsEl.innerHTML = `<span class="status-full">Fullbokat (${bookedSeats}/${totalSeats})</span>`
  } else {
      seatsEl.innerHTML = `<span class="status-open">${bookedSeats} av ${totalSeats} bokade</span>`
  }

  // 4. Deltagare
  const container = document.getElementById("participantsContainer")
  container.innerHTML = ""

  if (participants.length === 0) {
      document.getElementById("noParticipantsMsg").style.display = "block"
  } else {
      document.getElementById("noParticipantsMsg").style.display = "none"
      participants.forEach(u => {
        const div = document.createElement("div")
        div.className = "avatar"
        // Visa första bokstaven om namn finns, annars ?
        div.textContent = u.name ? u.name[0].toUpperCase() : "?"
        // Tooltip med hela namnet när man håller musen över
        div.title = u.name || "Okänd användare"
        container.appendChild(div)
      })
  }
}

// ---------------- INIT ----------------
document.getElementById("leaveBtn").onclick = async () => {
  if (confirm("Vill du lämna träffen?")) {
    await leaveActivity()
  }
}

;(async () => {
  currentUser = await getProfile()
  if (!currentUser) {
    alert("Du måste vara inloggad")
    return
  }

  if (!activityId) {
     document.getElementById("groupName").textContent = "Ingen träff vald"
     return
  }

  try {
    // Hämta data
    activity = await getActivity(activityId)
    participants = await getParticipants(activityId)
    currentLocation = await getLocation(activity.locationId)

    // Om användaren inte är med, lägg till automatiskt (som i din förra kod)
    const isMember = participants.some(p => p.id === currentUser.id)
    if (!isMember) {
      // Kontrollera om det finns plats innan vi joinar
      if (participants.length < activity.seats) {
          await joinActivity()
          participants = await getParticipants(activityId)
      } else {
          alert("Tyvärr, träffen är fullbokad!")
          window.location.href = "activities.html"
          return
      }
    }

    render()
  } catch (err) {
    console.error(err)
    document.getElementById("groupName").textContent = "Kunde inte ladda träff"
  }
})()
</script>

</body>
</html>
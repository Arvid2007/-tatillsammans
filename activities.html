<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8">
<title>Hitta & Boka</title>
<link rel="stylesheet" href="styles.css">
<link rel="icon" type="image/png" sizes="128x128" href="logowebb.png">
<style>
body { font-family: 'Poppins', sans-serif; background-color: #fafafa; margin:0; color:#333; }
.group-section { max-width:1200px; margin:50px auto; padding:20px; }
.group-section h2 { text-align:center; margin-bottom:25px; font-weight:600; color:#333; }
.group-layout { display:grid; grid-template-columns:1fr 1fr; gap:40px; }
.create-group { background:transparent; padding:25px; margin-bottom:35px; box-shadow:0 4px 12px rgba(0,0,0,0.05); display:flex; flex-direction:column; align-items:center; }
.create-group form { width:100%; max-width:500px; display:flex; flex-direction:column; gap:12px; }
.create-group input, .create-group button { padding:12px; border:2px solid #333; }
.group-list { padding:25px; box-shadow:0 4px 12px rgba(0,0,0,0.05); }
.search-input { width:100%; padding:12px; border:2px solid #333; margin-bottom:20px; }
.group-card { border:2px solid #333; padding:20px; margin-bottom:15px; }
.participants { display:flex; gap:8px; margin-top:10px; }
.avatar { width:34px; height:34px; border-radius:50%; background:black; color:white; display:flex; align-items:center; justify-content:center; font-size:13px; }
.join-btn { padding:10px; border:2px solid black; background:transparent; cursor:pointer; }
.joined { background:black; color:white; }
.leave-btn { padding:10px; border:2px solid red; background:transparent; color:red; cursor:pointer; }
.chat-btn { padding:10px; border:2px solid green; background:transparent; color:green; }
</style>
</head>
<body>

<script>
// global app state
const AppState = {
  userId: -1,
}

// call API
const serverAddress = "http://localhost:3123";
</script>

<!-- NAVBAR -->
<div class="navbar">
  <div class="icon" id="menuToggle">☰</div>
  <div class="logo"><a href="index.html"><img src="logo.png" alt="Logo"></a></div>
  <div class="icon"><a href="profile.html"><img src="profile.png" alt="Profil"></a></div>
</div>

<div class="dropdown" id="menu">
  <a href="index.html">Hem</a>
  <a href="activities.html">Hitta & Boka</a>
  <a href="index.html#about">Om oss</a>
  <a href="profile.html">Min Profil</a>
</div>

<section class="hero">
  <div class="hero-content">
    <h1>Hitta & Boka</h1>
  </div>
</section>

<section class="group-section">
<h2>Skapa eller gå med i träffar</h2>
<div class="group-layout">

  <!-- Skapa träff -->
  <div class="create-group">
    <h3>Skapa en ny träff</h3>
    <form id="createGroupForm">
      <input id="groupName" placeholder="Träffens namn" required>
      <input id="groupCity" placeholder="Stad" required>
      <input id="groupAdress" placeholder="Adress" required>
      <input id="groupTime" type="datetime-local" required>
      <input id="groupLimit" type="number" placeholder="Platser" min="1" required>
      <button type="submit">Skapa träff</button>
      <p id="loginMessage" style="color:red; display:none; margin-top:10px;">
        Du måste vara inloggad för att skapa en träff!
      </p>
    </form>
  </div>

  <!-- Lista träffar -->
  <div class="group-list">
    <h3>Alla träffar</h3>
    <input id="searchInput" class="search-input" placeholder="Sök träff...">
    <div id="groupsContainer"></div>
  </div>

</div>
</section>

<script src="api-server.js"></script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  const menuToggle = document.getElementById("menuToggle");
  const menu = document.getElementById("menu");
  menuToggle.addEventListener("click", () => {
    menu.style.display = menu.style.display === "block" ? "none" : "block";
  });

  const createForm = document.getElementById("createGroupForm");
  const loginMessage = document.getElementById("loginMessage");
  const groupsContainer = document.getElementById("groupsContainer");
  const searchInput = document.getElementById("searchInput");

  let currentUser = null; // användaren från backend
  let groups = []; // kommer från backend

  // --- Kontrollera inloggad användare ---
  async function checkUser() {
    try {
      const profile = await getProfile();
      if(profile) currentUser = profile;
    } catch {}
  }

  // --- Hämta träffar från backend ---
  async function fetchGroups() {
    try {
      const res = await fetch('http://localhost:3123/groups'); // backend endpoint
      if(!res.ok) throw new Error('Kunde inte hämta träffar');
      groups = await res.json();
      renderGroups();
    } catch(err) { console.error(err); }
  }

  // --- Rendera träffar ---
  function renderGroups() {
    groupsContainer.innerHTML = "";
    groups.forEach(group => {
      const joined = currentUser && group.members.includes(currentUser.id);
      const card = document.createElement("div");
      card.className = "group-card";
      card.setAttribute("data-name", group.name.toLowerCase());
      card.innerHTML = `
        <h3>${group.name}</h3>
        <p>${group.city} • ${new Date(group.time).toLocaleString("sv-SE")}</p>
        <p>${group.members.length} / ${group.limit} platser</p>
        <div class="participants">
          ${group.members.map(m => `<div class="avatar">${m[0]}</div>`).join("")}
        </div>
        <div style="display:flex; gap:8px; margin-top:10px;">
          <button class="join-btn ${joined ? "joined" : ""}">${joined ? "Du är med" : "Gå med"}</button>
        </div>
      `;
      card.querySelector(".join-btn").onclick = async () => {
        if(!currentUser){
          alert("Du måste logga in för att gå med i en träff!");
          return;
        }
        try{
          const action = joined ? 'leave' : 'join';
          const res = await fetch(`http://localhost:3123/groups/${group.id}/${action}`, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({userId: currentUser.id})});
          if(!res.ok) throw new Error('Misslyckades');
          await fetchGroups();
        } catch(err){ alert(err.message); }
      };
      groupsContainer.appendChild(card);
    });
  }

  // --- Skapa träff ---
  createForm.addEventListener("submit", async e => {
    e.preventDefault();
    if(!currentUser){
      loginMessage.style.display="block";
      loginMessage.scrollIntoView({ behavior: "smooth" });
      return;
    }
    const name = document.getElementById("groupName").value;
    const city = document.getElementById("groupCity").value;
    const adress = document.getElementById("groupAdress").value;
    const time = document.getElementById("groupTime").value;
    const limit = Number(document.getElementById("groupLimit").value);
    try{
      const res = await fetch('http://localhost:3123/groups', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({name, city, adress, time, limit, members:[currentUser.id]})
      });
      if(!res.ok) throw new Error('Misslyckades att skapa träff');
      createForm.reset();
      loginMessage.style.display="none";
      await fetchGroups();
    } catch(err){ alert(err.message); }
  });

  // --- Sökfunktion ---
  searchInput.addEventListener("input", e => {
    const search = e.target.value.toLowerCase();
    document.querySelectorAll(".group-card").forEach(card => {
      card.style.display = card.getAttribute("data-name").includes(search) ? "block" : "none";
    });
  });

  // Init
  (async () => {
    await checkUser();
    await fetchGroups();
  })();

});
</script>

<footer style="background:#222; color:#fff; text-align:center; padding:20px; font-size:14px;">
  <p>© 2026 Äta Tillsammans. Alla rättigheter förbehållna.</p>
  <p>Kontakt: info@atatillsammans.se | Tel: 08-123 456 78</p>
  <p>
    <a href="privacy.html" style="color:#fff; text-decoration:underline;">Integritetspolicy</a> | 
    <a href="terms.html" style="color:#fff; text-decoration:underline;">Användarvillkor</a>
  </p>
  <p>Följ oss: 
    <a href="#" style="color:#fff;">Facebook</a> | 
    <a href="#" style="color:#fff;">Instagram</a>
  </p>
</footer>

</body>
</html>

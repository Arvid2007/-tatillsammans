<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hitta & Boka</title>
  
  <link rel="stylesheet" href="styles.css">
  
  <link rel="icon" type="image/png" sizes="128x128" href="logowebb.png">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
</head>
<body>

  <div class="navbar">
    <div class="icon" onclick="toggleMenu()">‚ò∞</div>
    
    <div class="logo">
      <a href="index.html"><img src="logo.png" alt="Logo"></a>
    </div>

    <div class="navbar-right">
      <div id="navUser"></div> <a href="profile.html" class="profile-icon">
        <img src="profile.png" alt="Profil">
      </a>
    </div>
  </div>

  <div class="dropdown" id="menu">
    <a href="index.html">Hem</a>
    <a href="activities.html">Hitta & Boka</a>
    <a href="index.html#about">Om oss</a>
    <a href="profile.html">Min Profil</a>
  </div>
  <section class="hero">
    <div class="hero-content">
      <h1>Hitta & Boka</h1>
    </div>
  </section>

  <section class="group-section">
    <h2>Skapa eller g√• med i tr√§ffar</h2>
    <div class="group-layout">
      
      <div class="create-group">
        <h3>Skapa en ny tr√§ff</h3>
        <form id="createGroupForm">
          <input id="groupName" placeholder="Tr√§ffens namn" required>
          
          <label style="font-size: 12px; color: #666; margin-bottom: -8px;">Plats</label>
          <select id="locationSelect" required>
              <option value="" disabled selected>V√§lj en plats...</option>
              <option value="NEW" style="font-weight: bold;">‚ûï Skapa ny plats</option>
          </select>

          <div id="newLocationFields">
              <input id="groupCity" placeholder="Stad">
              <input id="groupAdress" placeholder="Adress">
          </div>

          <div style="display: flex; flex-direction: column;">
            <label style="font-size: 12px; color: #666; margin-bottom: 4px;">Tidpunkt</label>
            <input id="groupTime" type="datetime-local" required>
          </div>
          <input id="groupLimit" type="number" placeholder="Antal platser" min="1" required>
          <button type="submit">Skapa tr√§ff</button>
          <p id="loginMessage" style="color:red; display:none; margin-top:10px; text-align: center;">
            Du m√•ste vara inloggad f√∂r att skapa en tr√§ff!
          </p>
        </form>
      </div>

      <div class="group-list">
        <h3>Alla tr√§ffar</h3>
        <input id="searchInput" class="search-input" placeholder="S√∂k tr√§ff...">
        <div id="groupsContainer">Laddar tr√§ffar...</div>
      </div>
    </div>
  </section>

  <footer>
    <p>¬© 2026 √Ñta Tillsammans. Alla r√§ttigheter f√∂rbeh√•llna.</p>
    <p>Kontakt: info@atatillsammans.se | Tel: 08-123 456 78</p>
    <p>
      <a href="privacy.html">Integritetspolicy</a> |
      <a href="terms.html">Anv√§ndarvillkor</a>
    </p>
  </footer>

  <script src="auth.js"></script> <script>
    // --- KONFIGURATION ---
    const API_URL = "http://localhost:3123";

    document.addEventListener("DOMContentLoaded", () => {
      // --- Navbar Toggle ---
      window.toggleMenu = function () {
        const menu = document.getElementById("menu");
        // √Ñndra display mellan flex och none f√∂r dropdownen
        menu.style.display = (menu.style.display === "flex") ? "none" : "flex";
      }

      // --- DOM Elements ---
      const createForm = document.getElementById("createGroupForm");
      const loginMessage = document.getElementById("loginMessage");
      const groupsContainer = document.getElementById("groupsContainer");
      const searchInput = document.getElementById("searchInput");
      const locationSelect = document.getElementById("locationSelect");
      const newLocationFields = document.getElementById("newLocationFields");
      const groupCityInput = document.getElementById("groupCity");
      const groupAdressInput = document.getElementById("groupAdress");

      // --- State ---
      let currentUser = null;
      let activities = [];
      let locations = [];
      let allUsers = [];

      // --- 1. Check User ---
      function checkUser() {
        if (typeof Auth !== 'undefined') {
          currentUser = Auth.getUser();
          Auth.updateNavbar();
        } else {
          // Fallback om auth.js inte laddades korrekt
          const storedUser = localStorage.getItem('user');
          if (storedUser) {
              currentUser = JSON.parse(storedUser);
              const navUser = document.getElementById('navUser');
              if(navUser) navUser.innerText = currentUser.name;
          }
        }
      }

      // --- 2. Fetch Data ---
      async function fetchData() {
        try {
          const [locRes, actRes, userRes] = await Promise.all([
            fetch(`${API_URL}/location`),
            fetch(`${API_URL}/activity`),
            fetch(`${API_URL}/users`)
          ]);

          locations = await locRes.json();
          activities = await actRes.json();
          allUsers = await userRes.json();

          populateLocationDropdown();
          renderActivities();
        } catch (error) {
          console.error("Error fetching data:", error);
          groupsContainer.innerHTML = "<p style='color:red'>Kunde inte ansluta till servern.</p>";
        }
      }

      // --- 3. Populate Location Dropdown ---
      function populateLocationDropdown() {
          while (locationSelect.options.length > 2) {
              locationSelect.remove(2);
          }

          locations.forEach(loc => {
              const option = document.createElement("option");
              option.value = loc.id;
              option.textContent = `${loc.address}, ${loc.city}`;
              locationSelect.appendChild(option);
          });
      }

      // --- 4. Toggle New Location Fields ---
      locationSelect.addEventListener('change', (e) => {
          if (e.target.value === 'NEW') {
              newLocationFields.style.display = 'flex';
              groupCityInput.setAttribute('required', 'true');
              groupAdressInput.setAttribute('required', 'true');
          } else {
              newLocationFields.style.display = 'none';
              groupCityInput.removeAttribute('required');
              groupAdressInput.removeAttribute('required');
          }
      });

      // --- 5. Render Activities ---
      async function renderActivities() {
        groupsContainer.innerHTML = "";
        const displayList = activities.slice().reverse();

        if (displayList.length === 0) {
          groupsContainer.innerHTML = "<p>Inga tr√§ffar hittades.</p>";
          return;
        }

        for (const activity of displayList) {
          const loc = locations.find(l => l.id === activity.locationId) || { city: "Ok√§nd", address: "" };

          let participants = [];
          let isJoined = false;
          let participantNames = "Inga deltagare √§n.";

          try {
            const pRes = await fetch(`${API_URL}/userActivity/activity/${activity.id}`);
            if (pRes.ok) {
              participants = await pRes.json();
              if (currentUser) {
                isJoined = participants.some(p => p.userId === currentUser.id);
              }
              if (participants.length > 0) {
                participantNames = participants.map(p => {
                  const userObj = allUsers.find(u => u.id === p.userId);
                  return userObj ? userObj.name : "Ok√§nd";
                }).join(", ");
              }
            }
          } catch (err) { console.error(err); }

          const spotsLeft = activity.seats - participants.length;
          const card = document.createElement("div");
          card.className = "group-card";
          card.setAttribute("data-name", activity.name.toLowerCase());

          card.innerHTML = `
            <h3 style="margin-top:0;">${activity.name}</h3>
            <p style="color:#666; font-size:14px;">
              üìç ${loc.address}, ${loc.city} <br>
              üìÖ ${new Date(activity.time).toLocaleString("sv-SE")}
            </p>
            <p style="font-size:14px;">Platser kvar: <b>${Math.max(0, spotsLeft)}</b> / ${activity.seats}</p>
            <div class="action-row">
              <button class="join-btn ${isJoined ? "joined" : ""}" id="btn-${activity.id}">
                ${isJoined ? "Du √§r med (L√§mna)" : "G√• med"}
              </button>
              <button class="view-btn" onclick="document.getElementById('list-${activity.id}').style.display = document.getElementById('list-${activity.id}').style.display === 'none' ? 'block' : 'none'">
                Visa deltagare
              </button>
              ${(currentUser && activity.creatorId === currentUser.id) ? `<button class="delete-btn" id="del-${activity.id}">Ta bort</button>` : ''}
            </div>
            <div id="list-${activity.id}" class="participants-list" style="display:none;">
              <strong>Deltagare:</strong> ${participantNames}
            </div>
          `;

          const btn = card.querySelector(`#btn-${activity.id}`);
          btn.onclick = async () => {
            if (!currentUser) {
              alert("Du m√•ste logga in f√∂r att g√• med i en tr√§ff!");
              return;
            }
            try {
              if (isJoined) {
                await fetch(`${API_URL}/userActivity`, {
                  method: 'DELETE',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ userId: currentUser.id, activityId: activity.id })
                });
              } else {
                if (spotsLeft <= 0) { alert("Fullbokat!"); return; }
                await fetch(`${API_URL}/userActivity`, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ userId: currentUser.id, activityId: activity.id })
                });
              }
              fetchData();
            } catch (err) { console.error(err); }
          };

          const delBtn = card.querySelector(`#del-${activity.id}`);
          if (delBtn) {
            delBtn.onclick = async () => {
              if (confirm("Vill du verkligen ta bort denna tr√§ff?")) {
                await fetch(`${API_URL}/activity`, {
                  method: 'DELETE',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ activityId: activity.id })
                });
                fetchData();
              }
            }
          }
          groupsContainer.appendChild(card);
        }
      }

      // --- 6. Create Group Logic ---
      createForm.addEventListener("submit", async e => {
        e.preventDefault();
        if (!currentUser) {
          loginMessage.style.display = "block";
          return;
        }
        const name = document.getElementById("groupName").value;
        const time = document.getElementById("groupTime").value;
        const limit = Number(document.getElementById("groupLimit").value);
        
        const selection = locationSelect.value;
        let finalLocationId = selection;

        try {
          if (selection === 'NEW') {
              const city = groupCityInput.value;
              const address = groupAdressInput.value;

              const locRes = await fetch(`${API_URL}/location`, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ name: "Plats f√∂r " + name, address: address, city: city })
              });
              if (!locRes.ok) throw new Error("Kunde inte skapa plats");
              const newLocation = await locRes.json();
              finalLocationId = newLocation.id;
          }

          const actRes = await fetch(`${API_URL}/activity`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, time, seats: limit, locationId: finalLocationId, creatorId: currentUser.id })
          });
          if (!actRes.ok) throw new Error("Kunde inte skapa tr√§ff");

          const newActivity = await actRes.json();
          
          await fetch(`${API_URL}/userActivity`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ userId: currentUser.id, activityId: newActivity.id })
          });

          createForm.reset();
          newLocationFields.style.display = 'none'; 
          groupCityInput.removeAttribute('required');
          
          loginMessage.style.display = "none";
          fetchData();
        } catch (err) { console.error(err); }
      });

      // --- 7. Search Function ---
      searchInput.addEventListener("input", e => {
        const search = e.target.value.toLowerCase();
        document.querySelectorAll(".group-card").forEach(card => {
          card.style.display = card.getAttribute("data-name").includes(search) ? "block" : "none";
        });
      });

      // --- Initialize ---
      checkUser();
      fetchData();
    });
  </script>

</body>
</html> 
<!DOCTYPE html>
<html lang="sv">
<head>
Â  <meta charset="UTF-8">
Â  <title>Hitta & Boka</title>
Â  <link rel="stylesheet" href="styles.css">
Â  <link rel="icon" type="image/png" sizes="128x128" href="logowebb.png">
Â  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
Â  <style>
Â  Â  body { font-family: 'Poppins', sans-serif; background-color: #fafafa; margin: 0; color: #333; }
Â  Â  
Â  Â  /* Navbar styles */
Â  Â  .navbar { display: flex; align-items: center; justify-content: space-between; padding: 20px 30px; background: #000; color: white; position: relative; height: 60px; }
Â  Â  .navbar .icon { font-size: 28px; cursor: pointer; color: white; z-index: 5; }
Â  Â  .navbar .logo { position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); z-index: 1; }
Â  Â  .navbar .logo img { height: 55px; display: block; }
Â  Â  .navbar-right { display: flex; align-items: center; gap: 20px; z-index: 100; }
Â  Â  #navUser { font-size: 14px; font-weight: 400; color: white; }
Â  Â  .profile-icon { background: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
Â  Â  .profile-icon img { height: 24px; width: auto; }

Â  Â  /* Dropdown */
Â  Â  .dropdown { display: none; position: absolute; top: 90px; left: 20px; background: white; border: 1px solid #ccc; z-index: 1000; flex-direction: column; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); }
Â  Â  .dropdown a { padding: 15px 25px; text-decoration: none; color: #000; display: block; border-bottom: 1px solid #eee; }

Â  Â  /* Hero */
Â  Â  .hero { background-image: url('hero.jpg'); background-size: cover; background-position: center; background-repeat: no-repeat; color: white; padding: 60px 20px; text-align: center; text-shadow: 0 2px 6px rgba(0, 0, 0, 0.8); }

Â  Â  /* Group Section */
Â  Â  .group-section { max-width: 1200px; margin: 50px auto; padding: 20px; }
Â  Â  .group-section h2 { text-align: center; margin-bottom: 25px; font-weight: 600; color: #333; }
Â  Â  .group-layout { display: grid; grid-template-columns: 1fr 1fr; gap: 40px; }

Â  Â  /* Form */
Â  Â  .create-group { background: white; padding: 25px; margin-bottom: 35px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); display: flex; flex-direction: column; align-items: center; border-radius: 8px; }
Â  Â  .create-group form { width: 100%; max-width: 500px; display: flex; flex-direction: column; gap: 12px; }
Â  Â  .create-group input, .create-group select, .create-group button { padding: 12px; border: 1px solid #ccc; border-radius: 5px; font-family: 'Poppins', sans-serif; }
Â  Â  .create-group button { background: #000; color: white; cursor: pointer; font-weight: 600; border: none; }
Â  Â  .create-group button:hover { opacity: 0.8; }
Â  Â  
Â  Â  /* New Location Fields Container */
Â  Â  #newLocationFields { display: none; flex-direction: column; gap: 12px; border-left: 3px solid #000; padding-left: 10px; margin-left: 5px; }

Â  Â  /* List */
Â  Â  .group-list { padding: 25px; background: white; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); }
Â  Â  .search-input { width: 100%; padding: 12px; border: 1px solid #ccc; margin-bottom: 20px; box-sizing: border-box; border-radius: 5px; }

Â  Â  /* Cards */
Â  Â  .group-card { border: 1px solid #eee; padding: 20px; margin-bottom: 15px; border-radius: 8px; background: #fdfdfd; position: relative; }
Â  Â  .participants-list { background: #f0f0f0; padding: 10px; margin-top: 10px; border-radius: 5px; font-size: 14px; }

Â  Â  /* Buttons */
Â  Â  .action-row { display: flex; align-items: center; gap: 10px; margin-top: 15px; flex-wrap: wrap; }
Â  Â  .join-btn { padding: 8px 16px; border: 1px solid #333; background: transparent; cursor: pointer; border-radius: 4px; font-weight: 600; }
Â  Â  .joined { background: #333; color: white; }
Â  Â  .view-btn { padding: 8px 16px; border: 1px solid #777; background: #fff; color: #333; cursor: pointer; border-radius: 4px; font-size: 14px; }
Â  Â  .view-btn:hover { background: #f0f0f0; }
Â  Â  .delete-btn { color: red; cursor: pointer; border: none; background: none; font-size: 12px; text-decoration: underline; margin-left: auto; }
Â  </style>
</head>
<body>

<div class="navbar">
Â  <div class="icon" onclick="toggleMenu()">â˜°</div>
Â  <div class="logo"><a href="index.html"><img src="logo.png" alt="Logo"></a></div>
Â  <div class="navbar-right">
Â  Â  <div id="navUser"></div>
Â  Â  <a href="profile.html" class="profile-icon"><img src="profile.png" alt="Profil"></a>
Â  </div>
</div>

<div class="dropdown" id="menu">
Â  <a href="index.html">Hem</a>
Â  <a href="activities.html">Hitta & Boka</a>
Â  <a href="index.html#about">Om oss</a>
Â  <a href="profile.html">Min Profil</a>
</div>

<section class="hero">
Â  <div class="hero-content">
Â  Â  <h1>Hitta & Boka</h1>
Â  </div>
</section>

<section class="group-section">
Â  <h2>Skapa eller gÃ¥ med i trÃ¤ffar</h2>
Â  <div class="group-layout">
Â  Â  <div class="create-group">
Â  Â  Â  <h3>Skapa en ny trÃ¤ff</h3>
Â  Â  Â  <form id="createGroupForm">
Â  Â  Â  Â  <input id="groupName" placeholder="TrÃ¤ffens namn" required>
Â  Â  Â  Â  
Â  Â  Â  Â  <label style="font-size: 12px; color: #666; margin-bottom: -8px;">Plats</label>
Â  Â  Â  Â  <select id="locationSelect" required>
Â  Â  Â  Â  Â  Â  <option value="" disabled selected>VÃ¤lj en plats...</option>
Â  Â  Â  Â  Â  Â  <option value="NEW" style="font-weight: bold;">â• Skapa ny plats</option>
Â  Â  Â  Â  Â  Â  </select>

Â  Â  Â  Â  <div id="newLocationFields">
Â  Â  Â  Â  Â  Â  <input id="groupCity" placeholder="Stad">
Â  Â  Â  Â  Â  Â  <input id="groupAdress" placeholder="Adress">
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div style="display: flex; flex-direction: column;">
Â  Â  Â  Â  Â  <label style="font-size: 12px; color: #666; margin-bottom: 4px;">Tidpunkt</label>
Â  Â  Â  Â  Â  <input id="groupTime" type="datetime-local" required>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <input id="groupLimit" type="number" placeholder="Antal platser" min="1" required>
Â  Â  Â  Â  <button type="submit">Skapa trÃ¤ff</button>
Â  Â  Â  Â  <p id="loginMessage" style="color:red; display:none; margin-top:10px; text-align: center;">
Â  Â  Â  Â  Â  Du mÃ¥ste vara inloggad fÃ¶r att skapa en trÃ¤ff!
Â  Â  Â  Â  </p>
Â  Â  Â  </form>
Â  Â  </div>

Â  Â  <div class="group-list">
Â  Â  Â  <h3>Alla trÃ¤ffar</h3>
Â  Â  Â  <input id="searchInput" class="search-input" placeholder="SÃ¶k trÃ¤ff...">
Â  Â  Â  <div id="groupsContainer">Laddar trÃ¤ffar...</div>
Â  Â  </div>
Â  </div>
</section>

<script>
Â  // --- CONFIGURATION ---
Â  const API_URL = "http://localhost:3123";

Â  document.addEventListener("DOMContentLoaded", () => {
Â  Â  // --- Navbar Toggle ---
Â  Â  window.toggleMenu = function () {
Â  Â  Â  const menu = document.getElementById("menu");
Â  Â  Â  menu.style.display = (menu.style.display === "flex") ? "none" : "flex";
Â  Â  }

Â  Â  // --- DOM Elements ---
Â  Â  const createForm = document.getElementById("createGroupForm");
Â  Â  const loginMessage = document.getElementById("loginMessage");
Â  Â  const groupsContainer = document.getElementById("groupsContainer");
Â  Â  const searchInput = document.getElementById("searchInput");
Â  Â  const locationSelect = document.getElementById("locationSelect");
Â  Â  const newLocationFields = document.getElementById("newLocationFields");
Â  Â  const groupCityInput = document.getElementById("groupCity");
Â  Â  const groupAdressInput = document.getElementById("groupAdress");

Â  Â  // --- State ---
Â  Â  let currentUser = null;
Â  Â  let activities = [];
Â  Â  let locations = [];
Â  Â  let allUsers = [];

Â  Â  // --- 1. Check User (Via Auth.js if available, else localStorage manually) ---
Â  Â  function checkUser() {
Â  Â  Â  if (typeof Auth !== 'undefined') {
Â  Â  Â  Â  currentUser = Auth.getUser();
Â  Â  Â  Â  Auth.updateNavbar();
Â  Â  Â  } else {
Â  Â  Â  Â  const storedUser = localStorage.getItem('user');
Â  Â  Â  Â  if (storedUser) currentUser = JSON.parse(storedUser);
Â  Â  Â  }
Â  Â  }

Â  Â  // --- 2. Fetch Data from API ---
Â  Â  async function fetchData() {
Â  Â  Â  try {
Â  Â  Â  Â  const [locRes, actRes, userRes] = await Promise.all([
Â  Â  Â  Â  Â  fetch(`${API_URL}/location`),
Â  Â  Â  Â  Â  fetch(`${API_URL}/activity`),
Â  Â  Â  Â  Â  fetch(`${API_URL}/users`)
Â  Â  Â  Â  ]);

Â  Â  Â  Â  locations = await locRes.json();
Â  Â  Â  Â  activities = await actRes.json();
Â  Â  Â  Â  allUsers = await userRes.json();

Â  Â  Â  Â  populateLocationDropdown();
Â  Â  Â  Â  renderActivities();
Â  Â  Â  } catch (error) {
Â  Â  Â  Â  console.error("Error fetching data:", error);
Â  Â  Â  Â  groupsContainer.innerHTML = "<p style='color:red'>Kunde inte ansluta till servern.</p>";
Â  Â  Â  }
Â  Â  }

Â  Â  // --- 3. Populate Location Dropdown ---
Â  Â  function populateLocationDropdown() {
Â  Â  Â  Â  while (locationSelect.options.length > 2) {
Â  Â  Â  Â  Â  Â  locationSelect.remove(2);
Â  Â  Â  Â  }

Â  Â  Â  Â  locations.forEach(loc => {
Â  Â  Â  Â  Â  Â  const option = document.createElement("option");
Â  Â  Â  Â  Â  Â  option.value = loc.id;
Â  Â  Â  Â  Â  Â  // VISAR: Adress, Stad
Â  Â  Â  Â  Â  Â  option.textContent = `${loc.address}, ${loc.city}`;
Â  Â  Â  Â  Â  Â  locationSelect.appendChild(option);
Â  Â  Â  Â  });
Â  Â  }

Â  Â  // --- 4. Toggle New Location Fields ---
Â  Â  locationSelect.addEventListener('change', (e) => {
Â  Â  Â  Â  if (e.target.value === 'NEW') {
Â  Â  Â  Â  Â  Â  newLocationFields.style.display = 'flex';
Â  Â  Â  Â  Â  Â  groupCityInput.setAttribute('required', 'true');
Â  Â  Â  Â  Â  Â  groupAdressInput.setAttribute('required', 'true');
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  newLocationFields.style.display = 'none';
Â  Â  Â  Â  Â  Â  groupCityInput.removeAttribute('required');
Â  Â  Â  Â  Â  Â  groupAdressInput.removeAttribute('required');
Â  Â  Â  Â  }
Â  Â  });

Â  Â  // --- 5. Render Activities ---
Â  Â  async function renderActivities() {
Â  Â  Â  groupsContainer.innerHTML = "";
Â  Â  Â  const displayList = activities.slice().reverse();

Â  Â  Â  if (displayList.length === 0) {
Â  Â  Â  Â  groupsContainer.innerHTML = "<p>Inga trÃ¤ffar hittades.</p>";
Â  Â  Â  Â  return;
Â  Â  Â  }

Â  Â  Â  for (const activity of displayList) {
Â  Â  Â  Â  const loc = locations.find(l => l.id === activity.locationId) || { city: "OkÃ¤nd", address: "" };

Â  Â  Â  Â  let participants = [];
Â  Â  Â  Â  let isJoined = false;
Â  Â  Â  Â  let participantNames = "Inga deltagare Ã¤n.";

Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  const pRes = await fetch(`${API_URL}/userActivity/activity/${activity.id}`);
Â  Â  Â  Â  Â  if (pRes.ok) {
Â  Â  Â  Â  Â  Â  participants = await pRes.json();
Â  Â  Â  Â  Â  Â  if (currentUser) {
Â  Â  Â  Â  Â  Â  Â  isJoined = participants.some(p => p.userId === currentUser.id);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  if (participants.length > 0) {
Â  Â  Â  Â  Â  Â  Â  participantNames = participants.map(p => {
Â  Â  Â  Â  Â  Â  Â  Â  const userObj = allUsers.find(u => u.id === p.userId);
Â  Â  Â  Â  Â  Â  Â  Â  return userObj ? userObj.name : "OkÃ¤nd";
Â  Â  Â  Â  Â  Â  Â  }).join(", ");
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  } catch (err) { console.error(err); }

Â  Â  Â  Â  const spotsLeft = activity.seats - participants.length;
Â  Â  Â  Â  const card = document.createElement("div");
Â  Â  Â  Â  card.className = "group-card";
Â  Â  Â  Â  card.setAttribute("data-name", activity.name.toLowerCase());

Â  Â  Â  Â  // HÃ„R VISAS ADRESS OCH STAD:
Â  Â  Â  Â  card.innerHTML = `
Â  Â  Â  Â  <h3 style="margin-top:0;">${activity.name}</h3>
Â  Â  Â  Â  <p style="color:#666; font-size:14px;">
Â  Â  Â  Â  Â  ğŸ“ ${loc.address}, ${loc.city} <br>
Â  Â  Â  Â  Â  ğŸ“… ${new Date(activity.time).toLocaleString("sv-SE")}
Â  Â  Â  Â  </p>
Â  Â  Â  Â  <p style="font-size:14px;">Platser kvar: <b>${Math.max(0, spotsLeft)}</b> / ${activity.seats}</p>
Â  Â  Â  Â  <div class="action-row">
Â  Â  Â  Â  Â  <button class="join-btn ${isJoined ? "joined" : ""}" id="btn-${activity.id}">
Â  Â  Â  Â  Â  Â  ${isJoined ? "Du Ã¤r med (LÃ¤mna)" : "GÃ¥ med"}
Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  <button class="view-btn" onclick="document.getElementById('list-${activity.id}').style.display = document.getElementById('list-${activity.id}').style.display === 'none' ? 'block' : 'none'">
Â  Â  Â  Â  Â  Â  Visa deltagare
Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  ${(currentUser && activity.creatorId === currentUser.id) ? `<button class="delete-btn" id="del-${activity.id}">Ta bort</button>` : ''}
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div id="list-${activity.id}" class="participants-list" style="display:none;">
Â  Â  Â  Â  Â  <strong>Deltagare:</strong> ${participantNames}
Â  Â  Â  Â  </div>
Â  Â  Â  `;

Â  Â  Â  Â  const btn = card.querySelector(`#btn-${activity.id}`);
Â  Â  Â  Â  btn.onclick = async () => {
Â  Â  Â  Â  Â  if (!currentUser) {
Â  Â  Â  Â  Â  Â  alert("Du mÃ¥ste logga in fÃ¶r att gÃ¥ med i en trÃ¤ff!");
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  if (isJoined) {
Â  Â  Â  Â  Â  Â  Â  await fetch(`${API_URL}/userActivity`, {
Â  Â  Â  Â  Â  Â  Â  Â  method: 'DELETE',
Â  Â  Â  Â  Â  Â  Â  Â  headers: { 'Content-Type': 'application/json' },
Â  Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify({ userId: currentUser.id, activityId: activity.id })
Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  if (spotsLeft <= 0) { alert("Fullbokat!"); return; }
Â  Â  Â  Â  Â  Â  Â  await fetch(`${API_URL}/userActivity`, {
Â  Â  Â  Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  Â  Â  Â  headers: { 'Content-Type': 'application/json' },
Â  Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify({ userId: currentUser.id, activityId: activity.id })
Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  fetchData();
Â  Â  Â  Â  Â  } catch (err) { console.error(err); }
Â  Â  Â  Â  };

Â  Â  Â  Â  const delBtn = card.querySelector(`#del-${activity.id}`);
Â  Â  Â  Â  if (delBtn) {
Â  Â  Â  Â  Â  delBtn.onclick = async () => {
Â  Â  Â  Â  Â  Â  if (confirm("Vill du verkligen ta bort denna trÃ¤ff?")) {
Â  Â  Â  Â  Â  Â  Â  await fetch(`${API_URL}/activity`, {
Â  Â  Â  Â  Â  Â  Â  Â  method: 'DELETE',
Â  Â  Â  Â  Â  Â  Â  Â  headers: { 'Content-Type': 'application/json' },
Â  Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify({ activityId: activity.id })
Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  fetchData();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  groupsContainer.appendChild(card);
Â  Â  Â  }
Â  Â  }

Â  Â  // --- 6. Create Group Logic ---
Â  Â  createForm.addEventListener("submit", async e => {
Â  Â  Â  e.preventDefault();
Â  Â  Â  if (!currentUser) {
Â  Â  Â  Â  loginMessage.style.display = "block";
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â  const name = document.getElementById("groupName").value;
Â  Â  Â  const time = document.getElementById("groupTime").value;
Â  Â  Â  const limit = Number(document.getElementById("groupLimit").value);
Â  Â  Â  
Â  Â  Â  const selection = locationSelect.value;
Â  Â  Â  let finalLocationId = selection;

Â  Â  Â  try {
Â  Â  Â  Â  // Step A: Handle Location
Â  Â  Â  Â  if (selection === 'NEW') {
Â  Â  Â  Â  Â  Â  const city = groupCityInput.value;
Â  Â  Â  Â  Â  Â  const address = groupAdressInput.value;

Â  Â  Â  Â  Â  Â  const locRes = await fetch(`${API_URL}/location`, {
Â  Â  Â  Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  Â  Â  Â  headers: { 'Content-Type': 'application/json' },
Â  Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify({ name: "Plats fÃ¶r " + name, address: address, city: city })
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  if (!locRes.ok) throw new Error("Kunde inte skapa plats");
Â  Â  Â  Â  Â  Â  const newLocation = await locRes.json();
Â  Â  Â  Â  Â  Â  finalLocationId = newLocation.id;
Â  Â  Â  Â  }

Â  Â  Â  Â  // Step B: Create Activity
Â  Â  Â  Â  const actRes = await fetch(`${API_URL}/activity`, {
Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  headers: { 'Content-Type': 'application/json' },
Â  Â  Â  Â  Â  body: JSON.stringify({ name, time, seats: limit, locationId: finalLocationId, creatorId: currentUser.id })
Â  Â  Â  Â  });
Â  Â  Â  Â  if (!actRes.ok) throw new Error("Kunde inte skapa trÃ¤ff");

Â  Â  Â  Â  const newActivity = await actRes.json();
Â  Â  Â  Â  
Â  Â  Â  Â  // Step C: Auto-join creator
Â  Â  Â  Â  await fetch(`${API_URL}/userActivity`, {
Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  headers: { 'Content-Type': 'application/json' },
Â  Â  Â  Â  Â  body: JSON.stringify({ userId: currentUser.id, activityId: newActivity.id })
Â  Â  Â  Â  });

Â  Â  Â  Â  // Reset form
Â  Â  Â  Â  createForm.reset();
Â  Â  Â  Â  newLocationFields.style.display = 'none'; 
Â  Â  Â  Â  groupCityInput.removeAttribute('required');
Â  Â  Â  Â  
Â  Â  Â  Â  loginMessage.style.display = "none";
Â  Â  Â  Â  fetchData();
Â  Â  Â  } catch (err) { console.error(err); }
Â  Â  });

Â  Â  // --- 7. Search Function ---
Â  Â  searchInput.addEventListener("input", e => {
Â  Â  Â  const search = e.target.value.toLowerCase();
Â  Â  Â  document.querySelectorAll(".group-card").forEach(card => {
Â  Â  Â  Â  card.style.display = card.getAttribute("data-name").includes(search) ? "block" : "none";
Â  Â  Â  });
Â  Â  });

Â  Â  // --- Initialize ---
Â  Â  checkUser();
Â  Â  fetchData();
Â  });
</script>

<footer style="background:#000; color:#fff; text-align:center; padding:30px; font-size:14px;">
Â  <p>Â© 2026 Ã„ta Tillsammans. Alla rÃ¤ttigheter fÃ¶rbehÃ¥llna.</p>
Â  <p>Kontakt: info@atatillsammans.se | Tel: 08-123 456 78</p>
Â  <p>
Â  Â  <a href="privacy.html" style="color:#aaa; text-decoration:underline;">Integritetspolicy</a> |
Â  Â  <a href="terms.html" style="color:#aaa; text-decoration:underline;">AnvÃ¤ndarvillkor</a>
Â  </p>
</footer>

<script src="auth.js"></script>

</body>
</html>
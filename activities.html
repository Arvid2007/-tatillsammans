<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <title>Hitta & Boka</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="icon" type="image/png" sizes="128x128" href="logowebb.png">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Poppins', sans-serif; background-color: #fafafa; margin: 0; color: #333; }

    /* Navbar styles */
    .navbar { display: flex; align-items: center; justify-content: space-between; padding: 20px 30px; background: #000; color: white; position: relative; height: 60px; }
    .navbar .icon { font-size: 28px; cursor: pointer; color: white; z-index: 5; }
    .navbar .logo { position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); z-index: 1; }
    .navbar .logo img { height: 55px; display: block; }
    .navbar-right { display: flex; align-items: center; gap: 20px; z-index: 100; }
    #navUser { font-size: 14px; font-weight: 400; color: white; }
    .profile-icon { background: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
    .profile-icon img { height: 24px; width: auto; }

    /* Dropdown */
    .dropdown { display: none; position: absolute; top: 90px; left: 20px; background: white; border: 1px solid #ccc; z-index: 1000; flex-direction: column; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); }
    .dropdown a { padding: 15px 25px; text-decoration: none; color: #000; display: block; border-bottom: 1px solid #eee; }

    /* Hero */
    .hero { background-image: url('hero.jpg'); background-size: cover; background-position: center; background-repeat: no-repeat; color: white; padding: 60px 20px; text-align: center; text-shadow: 0 2px 6px rgba(0, 0, 0, 0.8); }

    /* Group Section */
    .group-section { max-width: 1200px; margin: 50px auto; padding: 20px; }
    .group-section h2 { text-align: center; margin-bottom: 25px; font-weight: 600; color: #333; }
    .group-layout { display: grid; grid-template-columns: 1fr 1fr; gap: 40px; }

    /* Form */
    .create-group { background: white; padding: 25px; margin-bottom: 35px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); display: flex; flex-direction: column; align-items: center; border-radius: 8px; }
    .create-group form { width: 100%; max-width: 500px; display: flex; flex-direction: column; gap: 12px; }
    .create-group input, .create-group button { padding: 12px; border: 1px solid #ccc; border-radius: 5px; font-family: 'Poppins', sans-serif; }
    .create-group button { background: #000; color: white; cursor: pointer; font-weight: 600; border: none; }
    .create-group button:hover { opacity: 0.8; }

    /* List */
    .group-list { padding: 25px; background: white; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); }
    .search-input { width: 100%; padding: 12px; border: 1px solid #ccc; margin-bottom: 20px; box-sizing: border-box; border-radius: 5px; }

    /* Cards */
    .group-card { border: 1px solid #eee; padding: 20px; margin-bottom: 15px; border-radius: 8px; background: #fdfdfd; position: relative; }
    .participants-list { background: #f0f0f0; padding: 10px; margin-top: 10px; border-radius: 5px; font-size: 14px; }

    /* Buttons */
    .action-row { display: flex; align-items: center; gap: 10px; margin-top: 15px; flex-wrap: wrap; }
    .join-btn { padding: 8px 16px; border: 1px solid #333; background: transparent; cursor: pointer; border-radius: 4px; font-weight: 600; }
    .joined { background: #333; color: white; }
    .view-btn { padding: 8px 16px; border: 1px solid #777; background: #fff; color: #333; cursor: pointer; border-radius: 4px; font-size: 14px; }
    .view-btn:hover { background: #f0f0f0; }
    .delete-btn { color: red; cursor: pointer; border: none; background: none; font-size: 12px; text-decoration: underline; margin-left: auto; }
  </style>
</head>
<body>

<div class="navbar">
  <div class="icon" onclick="toggleMenu()">‚ò∞</div>
  <div class="logo"><a href="index.html"><img src="logo.png" alt="Logo"></a></div>
  <div class="navbar-right">
    <div id="navUser"></div>
    <a href="profile.html" class="profile-icon"><img src="profile.png" alt="Profil"></a>
  </div>
</div>

<div class="dropdown" id="menu">
  <a href="index.html">Hem</a>
  <a href="activities.html">Hitta & Boka</a>
  <a href="index.html#about">Om oss</a>
  <a href="profile.html">Min Profil</a>
</div>

<section class="hero">
  <div class="hero-content">
    <h1>Hitta & Boka</h1>
  </div>
</section>

<section class="group-section">
  <h2>Skapa eller g√• med i tr√§ffar</h2>
  <div class="group-layout">
    <div class="create-group">
      <h3>Skapa en ny tr√§ff</h3>
      <form id="createGroupForm">
        <input id="groupName" placeholder="Tr√§ffens namn" required>
        <input id="groupCity" placeholder="Stad" required>
        <input id="groupAdress" placeholder="Adress" required>
        <div style="display: flex; flex-direction: column;">
          <label style="font-size: 12px; color: #666; margin-bottom: 4px;">Tidpunkt</label>
          <input id="groupTime" type="datetime-local" required>
        </div>
        <input id="groupLimit" type="number" placeholder="Antal platser" min="1" required>
        <button type="submit">Skapa tr√§ff</button>
        <p id="loginMessage" style="color:red; display:none; margin-top:10px; text-align: center;">
          Du m√•ste vara inloggad f√∂r att skapa en tr√§ff!
        </p>
      </form>
    </div>

    <div class="group-list">
      <h3>Alla tr√§ffar</h3>
      <input id="searchInput" class="search-input" placeholder="S√∂k tr√§ff...">
      <div id="groupsContainer">Laddar tr√§ffar...</div>
    </div>
  </div>
</section>

<script>
  // --- CONFIGURATION ---
  const API_URL = "http://localhost:3123";

  document.addEventListener("DOMContentLoaded", () => {
    // --- Navbar Toggle ---
    window.toggleMenu = function () {
      const menu = document.getElementById("menu");
      menu.style.display = (menu.style.display === "flex") ? "none" : "flex";
    }

    // --- DOM Elements ---
    const createForm = document.getElementById("createGroupForm");
    const loginMessage = document.getElementById("loginMessage");
    const groupsContainer = document.getElementById("groupsContainer");
    const searchInput = document.getElementById("searchInput");

    // --- State ---
    let currentUser = null;
    let activities = [];
    let locations = [];
    let allUsers = [];

    // --- 1. Check User ---
    function checkUser() {
      const storedUser = localStorage.getItem('user');
      if (storedUser) {
        currentUser = JSON.parse(storedUser);
      }
    }

    // --- 2. Fetch Data from API ---
    async function fetchData() {
      try {
        // Fetch Locations, Activities AND Users in parallel
        const [locRes, actRes, userRes] = await Promise.all([
          fetch(`${API_URL}/location`),
          fetch(`${API_URL}/activity`),
          fetch(`${API_URL}/users`)
        ]);

        locations = await locRes.json();
        activities = await actRes.json();
        allUsers = await userRes.json();

        renderActivities();
      } catch (error) {
        console.error("Error fetching data:", error);
        groupsContainer.innerHTML = "<p style='color:red'>Kunde inte ansluta till servern.</p>";
      }
    }

    // --- 3. Render Activities ---
    async function renderActivities() {
      groupsContainer.innerHTML = "";

      // Reverse to show newest first
      const displayList = activities.slice().reverse();

      if (displayList.length === 0) {
        groupsContainer.innerHTML = "<p>Inga tr√§ffar hittades.</p>";
        return;
      }

      // Loop through activities
      for (const activity of displayList) {
        const loc = locations.find(l => l.id === activity.locationId) || { city: "Ok√§nd", address: "" };

        // Fetch participant IDs for this specific activity
        let participants = [];
        let isJoined = false;
        let participantNames = "Inga deltagare √§n.";

        try {
          const pRes = await fetch(`${API_URL}/userActivity/activity/${activity.id}`);
          if (pRes.ok) {
            participants = await pRes.json(); // returns array of { userId, activityId }

            // Check if current user is joined
            if (currentUser) {
              isJoined = participants.some(p => p.userId === currentUser.id);
            }

            // Convert IDs to Names (UPDATED HERE: Using userObj.name)
            if (participants.length > 0) {
              participantNames = participants.map(p => {
                const userObj = allUsers.find(u => u.id === p.userId);
                // We use userObj.name first, if missing fallback to "Ok√§nd"
                return userObj ? userObj.name : "Ok√§nd";
              }).join(", ");
            }
          }
        } catch (err) { console.error(err); }

        const spotsLeft = activity.seats - participants.length;

        // Create HTML Card
        const card = document.createElement("div");
        card.className = "group-card";
        card.setAttribute("data-name", activity.name.toLowerCase());

        card.innerHTML = `
        <h3 style="margin-top:0;">${activity.name}</h3>
        <p style="color:#666; font-size:14px;">
          üìç ${loc.city}, ${loc.address} <br>
          üìÖ ${new Date(activity.time).toLocaleString("sv-SE")}
        </p>
        <p style="font-size:14px;">Platser kvar: <b>${Math.max(0, spotsLeft)}</b> / ${activity.seats}</p>
        <div class="action-row">
          <button class="join-btn ${isJoined ? "joined" : ""}" id="btn-${activity.id}">
            ${isJoined ? "Du √§r med (L√§mna)" : "G√• med"}
          </button>
          <button class="view-btn" onclick="document.getElementById('list-${activity.id}').style.display = document.getElementById('list-${activity.id}').style.display === 'none' ? 'block' : 'none'">
            Visa deltagare
          </button>
          ${(currentUser && activity.creatorId === currentUser.id) ? `<button class="delete-btn" id="del-${activity.id}">Ta bort</button>` : ''}
        </div>
        <div id="list-${activity.id}" class="participants-list" style="display:none;">
          <strong>Deltagare:</strong> ${participantNames}
        </div>
      `;

        // --- Button Logic: Join / Leave ---
        const btn = card.querySelector(`#btn-${activity.id}`);
        btn.onclick = async () => {
          if (!currentUser) {
            alert("Du m√•ste logga in f√∂r att g√• med i en tr√§ff!");
            return;
          }

          try {
            if (isJoined) {
              // LEAVE
              await fetch(`${API_URL}/userActivity`, {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ userId: currentUser.id, activityId: activity.id })
              });
            } else {
              // JOIN
              if (spotsLeft <= 0) { alert("Fullbokat!"); return; }
              await fetch(`${API_URL}/userActivity`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ userId: currentUser.id, activityId: activity.id })
              });
            }
            fetchData(); // Refresh list
          } catch (err) { console.error(err); }
        };

        // --- Button Logic: Delete (Creator only) ---
        const delBtn = card.querySelector(`#del-${activity.id}`);
        if (delBtn) {
          delBtn.onclick = async () => {
            if (confirm("Vill du verkligen ta bort denna tr√§ff?")) {
              await fetch(`${API_URL}/activity`, {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ activityId: activity.id })
              });
              fetchData();
            }
          }
        }
        groupsContainer.appendChild(card);
      }
    }

    // --- 4. Create Group Logic ---
    createForm.addEventListener("submit", async e => {
      e.preventDefault();
      if (!currentUser) {
        loginMessage.style.display = "block";
        return;
      }
      const name = document.getElementById("groupName").value;
      const city = document.getElementById("groupCity").value;
      const address = document.getElementById("groupAdress").value;
      const time = document.getElementById("groupTime").value;
      const limit = Number(document.getElementById("groupLimit").value);

      try {
        const locRes = await fetch(`${API_URL}/location`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name: "Plats f√∂r " + name, address: address, city: city })
        });
        if (!locRes.ok) throw new Error("Kunde inte skapa plats");
        const newLocation = await locRes.json();

        const actRes = await fetch(`${API_URL}/activity`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, time, seats: limit, locationId: newLocation.id, creatorId: currentUser.id })
        });
        if (!actRes.ok) throw new Error("Kunde inte skapa tr√§ff");

        const newActivity = await actRes.json();
        // Auto-join creator
        await fetch(`${API_URL}/userActivity`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userId: currentUser.id, activityId: newActivity.id })
        });

        createForm.reset();
        loginMessage.style.display = "none";
        fetchData();
      } catch (err) { console.error(err); }
    });

    // --- 5. Search Function ---
    searchInput.addEventListener("input", e => {
      const search = e.target.value.toLowerCase();
      document.querySelectorAll(".group-card").forEach(card => {
        card.style.display = card.getAttribute("data-name").includes(search) ? "block" : "none";
      });
    });

    // --- Initialize ---
    checkUser();
    fetchData();
  });
</script>

<footer style="background:#000; color:#fff; text-align:center; padding:30px; font-size:14px;">
  <p>¬© 2026 √Ñta Tillsammans. Alla r√§ttigheter f√∂rbeh√•llna.</p>
  <p>Kontakt: info@atatillsammans.se | Tel: 08-123 456 78</p>
  <p>
    <a href="privacy.html" style="color:#aaa; text-decoration:underline;">Integritetspolicy</a> |
    <a href="terms.html" style="color:#aaa; text-decoration:underline;">Anv√§ndarvillkor</a>
  </p>
</footer>

<script src="auth.js"></script>

</body>
</html>
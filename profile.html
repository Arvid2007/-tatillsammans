<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Äta Tillsammans - Profil</title>
  
  <link rel="stylesheet" href="styles.css">
  
  <link rel="icon" type="image/png" sizes="128x128" href="logowebb.png">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
</head>
<body>

  <div class="navbar">
    <div class="icon" onclick="toggleMenu()">☰</div>
    
    <div class="logo">
      <a href="index.html"><img src="logo.png" alt="Logo"></a>
    </div>

    <div class="navbar-right">
      <div id="navUser"></div>
      <a href="profile.html" class="profile-icon">
        <img src="profile.png" alt="Profil">
      </a>
    </div>
  </div>

  <div class="dropdown" id="menu">
    <a href="index.html">Hem</a>
    <a href="activities.html">Hitta & Boka</a>
    <a href="index.html#about">Om oss</a>
    <a href="profile.html">Min Profil</a>
  </div>
  <div class="profile-section">
    
    <div class="container" id="authContainer">
      <div>
        <h1 style="margin-top:-5px;">Välkommen</h1>
        <p>Skapa konto / Logga in</p>
        <hr style="margin:25px auto;width:20%; border: 1px solid #eee;">
      </div>

      <div class="tabs">
        <button id="loginTab" class="active" onclick="switchTab('login')">Logga in</button>
        <button id="registerTab" onclick="switchTab('register')">Skapa konto</button>
      </div>

      <form id="loginForm" class="form active">
        <input type="email" name="username" placeholder="E-post" required>
        <input type="password" name="password" placeholder="Lösenord" required>
        <button type="submit">Logga in</button>
        <div class="message error" id="loginMsg"></div>
      </form>

      <form id="registerForm" class="form">
        <input type="text" name="name" id="regName" placeholder="Namn (För- och efternamn)" required>
        <input type="number" name="age" id="regAge" placeholder="Ålder" required>
        <input type="email" name="username" id="regEmail" placeholder="E-post (Användarnamn)" required>
        <input type="password" name="password" id="regPassword" placeholder="Lösenord" required>
        <button type="submit">Skapa konto</button>
        <div class="message error" id="regMsg"></div>
      </form>
    </div>

    <div class="container" id="profileCard" style="display:none;">
      <h2 style="margin-top:0;">Din Profil</h2>
      <div id="profileAvatar">AA</div>
      <table class="profile-table">
        <tr><td><strong>Namn:</strong></td><td id="profileName"></td></tr>
        <tr><td><strong>Ålder:</strong></td><td id="profileAge"></td></tr>
        <tr><td><strong>E-post:</strong></td><td id="profileUsername"></td></tr>
      </table>
      <div class="info">
        <button onclick="logout()" style="background-color: #333;">Logga ut</button>
      </div>
    </div>

  </div>

  <footer>
    <p>© 2026 Äta Tillsammans. Alla rättigheter förbehållna.</p>
    <p>Kontakt: info@atatillsammans.se</p>
  </footer>

  <script src="auth.js"></script>
  <script>
    const API_URL = 'http://localhost:3123';

    // Elementreferenser
    const authContainer = document.getElementById("authContainer");
    const profileCard = document.getElementById("profileCard");
    const navUserDiv = document.getElementById("navUser");

    // --- Initiering vid start ---
    document.addEventListener('DOMContentLoaded', () => {
      // 1. Navbar funktion
      window.toggleMenu = function () {
        const menu = document.getElementById("menu");
        menu.style.display = (menu.style.display === "flex") ? "none" : "flex";
      }

      // 2. Kolla om användare redan är inloggad
      const storedUser = localStorage.getItem('user');
      if (storedUser) {
        try {
          const user = JSON.parse(storedUser);
          handleLoginSuccess(user);
        } catch (e) {
          localStorage.removeItem('user');
        }
      }
    });

    // --- Flikar (Logga in / Skapa konto) ---
    function switchTab(type) {
      document.getElementById('regMsg').style.display = 'none';
      document.getElementById('loginMsg').style.display = 'none';

      if (type === 'login') {
        document.getElementById("loginForm").classList.add('active');
        document.getElementById("registerForm").classList.remove('active');
        document.getElementById("loginTab").classList.add('active');
        document.getElementById("registerTab").classList.remove('active');
      } else {
        document.getElementById("loginForm").classList.remove('active');
        document.getElementById("registerForm").classList.add('active');
        document.getElementById("loginTab").classList.remove('active');
        document.getElementById("registerTab").classList.add('active');
      }
    }

    // --- Registrering ---
    document.getElementById("registerForm").addEventListener("submit", async function(e) {
      e.preventDefault();
      const msgDiv = document.getElementById("regMsg");
      msgDiv.style.display = 'none';

      const data = {
        name: document.getElementById("regName").value,
        age: Number(document.getElementById("regAge").value),
        username: document.getElementById("regEmail").value,
        password: document.getElementById("regPassword").value
      };

      try {
        const response = await fetch(`${API_URL}/users`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        if (response.status === 201) {
          const user = await response.json();
          // Spara användaren och logga in direkt
          localStorage.setItem('user', JSON.stringify(user));
          handleLoginSuccess(user);
          // Valfritt: Skicka till startsidan
          // window.location.href = 'index.html'; 
        } else if (response.status === 409) {
          msgDiv.textContent = "E-postadressen används redan.";
          msgDiv.style.display = 'block';
        } else {
          msgDiv.textContent = "Något gick fel. Försök igen.";
          msgDiv.style.display = 'block';
        }
      } catch (error) {
        console.error(error);
        msgDiv.textContent = "Kunde inte nå servern.";
        msgDiv.style.display = 'block';
      }
    });

    // --- Inloggning ---
    document.getElementById("loginForm").addEventListener("submit", async function(e) {
      e.preventDefault();
      const msgDiv = document.getElementById("loginMsg");
      msgDiv.style.display = 'none';

      const formData = new FormData(e.target);
      const data = Object.fromEntries(formData.entries());

      try {
        const response = await fetch(`${API_URL}/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        if (response.ok) {
          const user = await response.json();
          localStorage.setItem('user', JSON.stringify(user));
          handleLoginSuccess(user);
        } else {
          msgDiv.textContent = "Fel e-post eller lösenord.";
          msgDiv.style.display = 'block';
        }
      } catch (error) {
        console.error(error);
        msgDiv.textContent = "Servern svarar inte (är den igång?).";
        msgDiv.style.display = 'block';
      }
    });

    // --- Hantera lyckad inloggning ---
    function handleLoginSuccess(user) {
      // Byt vy från formulär till profilkort
      authContainer.style.display = 'none';
      profileCard.style.display = 'block';

      // Fyll i information
      document.getElementById("profileName").textContent = user.name;
      document.getElementById("profileAge").textContent = user.age + " år";
      document.getElementById("profileUsername").textContent = user.username;

      // Uppdatera Navbar
      navUserDiv.textContent = user.name;

      // Skapa initialer till avatar
      if (user.name) {
        const parts = user.name.trim().split(" ");
        let initials = parts[0][0];
        if (parts.length > 1) initials += parts[parts.length - 1][0];
        document.getElementById("profileAvatar").textContent = initials.toUpperCase();
      }
    }

    // --- Logga ut ---
    function logout() {
      localStorage.removeItem('user');
      navUserDiv.textContent = "";
      
      profileCard.style.display = 'none';
      authContainer.style.display = 'block';
      
      // Återställ formulär
      document.getElementById("registerForm").reset();
      document.getElementById("loginForm").reset();
      switchTab('login');
    }
  </script>
</body>
</html>